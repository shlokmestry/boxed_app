rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ─────────────────────────────────────────────
    // CAPSULES
    // ─────────────────────────────────────────────
    match /capsules/{capsuleId} {

      // READ: only members (capsule metadata)
      allow read: if request.auth != null
        && request.auth.uid in resource.data.memberIds;

      // CREATE: creator only
      allow create: if request.auth != null
        && request.resource.data.creatorId == request.auth.uid
        && request.auth.uid in request.resource.data.memberIds
        && request.resource.data.status in ['pending', 'locked'];

      // UPDATE:
      allow update: if request.auth != null
        && (
          // Creator can manage capsule until unlock
          (
            request.auth.uid == resource.data.creatorId
            && request.time < resource.data.unlockDate
          )

          ||

          // Collaborator can accept invite only
          (
            request.auth.uid in resource.data.memberIds
            && request.resource.data
              .diff(resource.data)
              .changedKeys()
              .hasOnly(['collaborators', 'status'])
          )
        );

      // DELETE: any member can delete (decline flow)
      allow delete: if request.auth != null
        && request.auth.uid in resource.data.memberIds;
    }

    // ─────────────────────────────────────────────
    // MEMORIES
    // ─────────────────────────────────────────────
    match /capsules/{capsuleId}/memories/{memoryId} {
      allow read: if request.auth != null
        && request.auth.uid in
          get(/databases/$(database)/documents/capsules/$(capsuleId))
            .data.memberIds
        && request.time >=
          get(/databases/$(database)/documents/capsules/$(capsuleId))
            .data.unlockDate;

      allow create: if request.auth != null
        && request.auth.uid in
          get(/databases/$(database)/documents/capsules/$(capsuleId))
            .data.memberIds
        && request.time <
          get(/databases/$(database)/documents/capsules/$(capsuleId))
            .data.unlockDate
        && get(/databases/$(database)/documents/capsules/$(capsuleId))
            .data.status == 'locked';
    }
  }
}
